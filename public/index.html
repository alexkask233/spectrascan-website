<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üõ°Ô∏è SpectraScan - Unmask Your Digital Ghost</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20384%20512'%3E%3Cpath%20fill='%23000000'%20d='M256%200C114.6%200%200%20114.6%200%20256s114.6%20256%20256%20256s256-114.6%20256-256S397.4%200%20256%200zM192%20160a32%2032%200%201%201-64%200%2032%2032%200%201%201%2064%200zm128%200a32%2032%200%201%201-64%200%2032%2032%200%201%201%2064%200zM160%20336H352c8.8%200%2016%207.2%2016%2016s-7.2%2016-16%2016H160c-8.8%200-16-7.2-16-16s7.2-16%2016-16z'/%3E%3C/svg%3E">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Roboto+Mono:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  
  <script src="https://cdn.jsdelivr.net/npm/@thumbmarkjs/thumbmarkjs/dist/thumbmark.umd.js"></script>

  <style>
    :root {
      --bg-color: #0d0d12; --card-color: rgba(30, 30, 36, 0.9); --border-color: #33333a; --text-primary: #f0f0f0; --text-secondary: #a9a9b3; --accent-green: #00ff88; --accent-red: #ff4757; --accent-blue: #00aaff; --success-bg: rgba(0, 255, 136, 0.1); --danger-bg: rgba(255, 71, 87, 0.1); --bg-grid-color: rgba(42, 42, 48, 0.7);
    }
    body.light-mode {
      --bg-color: #f4f4f8; --card-color: #ffffff; --border-color: #e0e0e6; --text-primary: #121217; --text-secondary: #66666e; --success-bg: rgba(0, 200, 110, 0.1); --danger-bg: rgba(255, 71, 87, 0.1); --bg-grid-color: rgba(220, 224, 230, 0.8);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    html { height: 100%; }
    body { height: 100%; background-color: var(--bg-color); color: var(--text-primary); font-family: 'Inter', sans-serif; line-height: 1.6; position: relative; }
    
    #matrix-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -2; transition: opacity 0.5s ease-in-out; }
    
    .page-wrapper { display: flex; flex-direction: column; min-height: 100vh; }
    main { flex-grow: 1; display: flex; justify-content: center; align-items: center; padding: 40px 20px; }

    #background-watermark {
        content: attr(data-text); position: fixed; top: 50%; left: 50%;
        transform: translate(-50%, -50%) rotate(-15deg);
        font-size: 15vw; font-family: 'Roboto Mono', monospace; font-weight: 700;
        opacity: 0; pointer-events: none; z-index: -1; transition: opacity 0.5s ease;
    }
    body.danger-mode #background-watermark {
        color: var(--accent-red); text-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
        opacity: 0.1; animation: watermark-flicker 2s infinite alternate;
    }
    body.safe-mode #background-watermark {
        color: var(--accent-blue); text-shadow: 0 0 10px rgba(0, 170, 255, 0.5);
        opacity: 0.05; animation: watermark-flicker 4s infinite alternate;
    }
    @keyframes watermark-flicker { 0%, 90% { opacity: 0.1; } 95% { opacity: 0.05; } 100% { opacity: 0.12; } }

    .page { display: none; width: 100%; max-width: 700px; }
    .page.active { display: block; animation: page-transition-in 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; }
    @keyframes page-transition-in { from { opacity: 0; transform: translateY(20px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }

    header { background-color: rgba(18, 18, 23, 0.8); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-bottom: 1px solid var(--border-color); padding: 0 40px; display: flex; justify-content: space-between; align-items: center; height: 70px; position: sticky; top: 0; z-index: 100; transition: background-color 0.3s ease, border-color 0.3s ease; }
    .logo-link { text-decoration: none; }
    .logo { font-size: 20px; font-weight: 700; display: flex; align-items: center; gap: 10px; color: var(--text-primary); }
    .logo .fa-shield-halved { color: var(--accent-green); }
    nav { display: flex; align-items: center; gap: 30px; }
    nav .nav-link { color: var(--text-secondary); text-decoration: none; font-weight: 500; transition: color 0.2s ease; }
    nav .nav-link:hover, nav .nav-link.active { color: var(--text-primary); }
    #theme-toggle-btn { background: none; border: none; color: var(--text-secondary); font-size: 20px; cursor: pointer; transition: color 0.2s ease, transform 0.2s ease; }
    #hamburger-btn, #close-nav-btn { display: none; background: none; border: none; font-size: 24px; color: var(--text-primary); cursor: pointer; }
    #close-nav-btn { position: absolute; top: 20px; right: 20px; }
    
    footer { text-align: center; padding: 20px; color: var(--text-secondary); font-size: 14px; background-color: var(--card-color); border-top: 1px solid var(--border-color); transition: background-color 0.3s ease, border-color 0.3s ease; font-family: 'Roboto Mono', monospace; }
    footer .footer-icons { margin-top: 10px; display: flex; justify-content: center; gap: 20px; font-size: 18px; color: var(--accent-green); }
    
    .container { background-color: var(--card-color); padding: 30px 40px; border-radius: 16px; border: 1px solid var(--border-color); box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); transition: background-color 0.3s ease, border-color 0.3s ease; position: relative; overflow: hidden; }
    
    .classified-stamp {
        position: absolute; top: 25px; right: 25px;
        transform: rotate(10deg); color: var(--accent-red);
        border: 3px solid var(--accent-red); padding: 5px 10px;
        font-family: 'Roboto Mono', monospace; font-weight: 700;
        font-size: 18px; opacity: 0.7; user-select: none;
        transition: all 0.4s ease;
    }
    .classified-stamp.safe { border-color: var(--accent-blue); color: var(--accent-blue); }
    .classified-stamp.danger { border-color: var(--accent-red); color: var(--accent-red); }

    h1, .static-page h2 {
        font-size: 2.2rem; font-weight: 700; margin-bottom: 10px; text-align: center; color: var(--text-primary);
        position: relative; animation: text-shadow-flicker 4s linear infinite;
    }
    @keyframes text-shadow-flicker {
        0%, 100% { text-shadow: 2px 2px 0 var(--accent-green), -2px -2px 0 var(--accent-red); }
        25% { text-shadow: -2px 2px 0 var(--accent-green), 2px -2px 0 var(--accent-red); }
        50% { text-shadow: 2px -2px 0 var(--accent-green), -2px 2px 0 var(--accent-red); }
        75% { text-shadow: -2px -2px 0 var(--accent-green), 2px 2px 0 var(--accent-red); }
    }
    
    .tagline { 
      color: var(--text-secondary); margin-bottom: 30px; font-size: 16px; text-align: center;
      font-family: 'Roboto Mono', monospace; white-space: nowrap; overflow: hidden;
      border-right: .15em solid var(--accent-green); animation: typing 2s steps(38, end), blink-caret .75s step-end infinite;
    }
    @keyframes typing { from { width: 0 } to { width: 100% } }
    @keyframes blink-caret { from, to { border-color: transparent } 50% { border-color: var(--accent-green); } }

    .run-btn-wrapper { display: flex; justify-content: center; }
    button#run-btn, button#reset-btn { padding: 15px 30px; font-size: 18px; font-weight: 700; border: none; border-radius: 10px; transition: all 0.3s ease; font-family: 'Inter', sans-serif; }
    button#run-btn { background: var(--accent-green); color: #000; box-shadow: 0 0 15px rgba(0, 255, 136, 0.3); }
    button#run-btn:hover { background-color: #00e67a; transform: translateY(-3px) scale(1.02); box-shadow: 0 0 25px rgba(0, 255, 136, 0.6); }
    
    button#reset-btn.safe-button { background-image: linear-gradient(45deg, #00ff88, #00e67a); color: #000; box-shadow: 0 0 20px rgba(0, 255, 136, 0.4); }
    button#reset-btn.safe-button:hover { transform: translateY(-2px); box-shadow: 0 0 30px rgba(0, 255, 136, 0.7); }
    button#reset-btn.danger-button { background-image: linear-gradient(45deg, #ff4757, #e03f4f); color: #fff; box-shadow: 0 0 20px rgba(255, 71, 87, 0.5); }
    button#reset-btn.danger-button:hover { transform: translateY(-2px); box-shadow: 0 0 30px rgba(255, 71, 87, 0.8); }
    
    #results-container { margin-top: 30px; text-align: left; }
    .loader-wrapper { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px 0; animation: page-transition-in 0.5s; }
    .scanner-circle { width: 60px; height: 60px; border: 4px solid var(--border-color); border-top-color: var(--accent-green); border-radius: 50%; animation: spin 1s linear infinite, pulse 2s ease-in-out infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes pulse { 0%, 100% { box-shadow: 0 0 0 0 rgba(0, 255, 138, 0.4); } 50% { box-shadow: 0 0 0 10px rgba(0, 255, 138, 0); } }
    .scanner-text { margin-top: 20px; color: var(--text-secondary); font-weight: 500; letter-spacing: 1px; text-transform: uppercase; }
    
    .verdict-box { padding: 20px; font-size: 22px; font-weight: 700; border-radius: 12px; border: 2px solid; display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 25px; animation: pulse-border 2s infinite; }
    .verdict-box.safe { background-color: var(--success-bg); border-color: var(--accent-green); color: var(--accent-green); box-shadow: 0 0 20px rgba(0, 255, 136, 0.3); }
    .verdict-box.danger { background-color: var(--danger-bg); border-color: var(--accent-red); color: var(--accent-red); box-shadow: 0 0 20px rgba(255, 71, 87, 0.4); }
    @keyframes pulse-border { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.01); } }
    
    .risk-score { font-size: 16px; color: var(--text-secondary); text-align: center; margin-bottom: 25px; }
    .risk-score strong { color: var(--text-primary); font-weight: 700; font-size: 18px; }
    
    .details-grid { display: grid; grid-template-columns: auto 1fr; gap: 12px 20px; padding: 20px 0; border-top: 1px solid var(--border-color); font-family: 'Roboto Mono', monospace; align-items: baseline; }
    .details-grid > * { opacity: 0; animation: fade-in-up 0.5s ease forwards; }
    @keyframes fade-in-up { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .details-grid .label { color: var(--text-secondary); text-align: right; white-space: pre; font-size: 14px; }
    .details-grid .value { color: var(--text-primary); font-size: 14px; word-break: break-all; }
    .details-grid .value.danger { color: var(--accent-red); font-weight: 700; }
    .details-grid .value.safe { color: var(--accent-green); }
    .details-grid .value.fingerprint-hash { color: var(--accent-blue); font-size: 13px;}

    .results-footer { text-align: center; padding-top: 30px; animation: fade-in-up 0.5s 0.5s ease forwards; opacity: 0; }
    .results-separator {
        width: 60%; margin: 0 auto 25px auto; height: 1px; 
        background-image: linear-gradient(to right, transparent, var(--border-color), transparent);
        display: flex; align-items: center; justify-content: center;
    }
    .results-separator::after {
        font-family: 'Font Awesome 6 Free'; font-weight: 900;
        content: '\f1e2'; /* fa-skull-crossbones */
        font-size: 16px; color: var(--accent-green);
        background: var(--card-color); padding: 0 15px;
        animation: pulse-icon-safe 2s infinite ease-in-out;
    }
    .results-separator.danger::after { color: var(--accent-red); animation-name: pulse-icon-danger; }
    @keyframes pulse-icon-safe { 0%, 100% { transform: scale(1); text-shadow: 0 0 5px var(--accent-green); } 50% { transform: scale(1.1); text-shadow: 0 0 15px var(--accent-green); } }
    @keyframes pulse-icon-danger { 0%, 100% { transform: scale(1); text-shadow: 0 0 5px var(--accent-red); } 50% { transform: scale(1.1); text-shadow: 0 0 15px var(--accent-red); } }
    
    .static-page p { color: var(--text-secondary); margin-bottom: 20px; line-height: 1.7; font-family: 'Roboto Mono', monospace; }
    .static-page h3 { color: var(--accent-blue); margin-top: 30px; margin-bottom: 10px; font-family: 'Roboto Mono', monospace; }
    
    @media (max-width: 768px) {
        header { padding: 0 20px; }
        nav .nav-link, nav #theme-toggle-btn { display: none; }
        #hamburger-btn { display: block; }
        nav { position: fixed; top: 0; right: -100%; width: 100%; height: 100vh; background: rgba(18, 18, 23, 0.95); backdrop-filter: blur(10px); flex-direction: column; justify-content: center; align-items: center; gap: 40px; transition: right 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        nav.is-open { right: 0; }
        nav.is-open .nav-link, nav.is-open #theme-toggle-btn, nav.is-open #close-nav-btn { display: block; font-size: 24px; }
        .container { padding: 20px; }
        h1, .static-page h2 { font-size: 24px; }
        .details-grid { grid-template-columns: 1fr; text-align: center; }
        .details-grid .label { text-align: center; }
        .details-grid .value { margin-bottom: 16px; }
    }
  </style>
</head>
<body>
<canvas id="matrix-bg"></canvas>
<div id="background-watermark"></div>

<div class="page-wrapper">
  <!-- ====== HEADER ====== -->
  <header>
    <a href="/" class="logo-link">
      <div class="logo">
        <i class="fa-solid fa-shield-halved"></i>
        <span>SpectraScan</span>
      </div>
    </a>
    <button id="hamburger-btn" aria-label="Open menu"><i class="fa-solid fa-bars"></i></button>
    <nav id="main-nav">
        <button id="close-nav-btn" aria-label="Close menu"><i class="fa-solid fa-times"></i></button>
        <a href="/" class="nav-link">Catcher</a>
        <a href="/faq" class="nav-link">FAQ</a>
        <a href="/privacy" class="nav-link">Privacy</a>
        <button id="theme-toggle-btn" title="Toggle theme"><i class="fa-solid fa-moon"></i></button>
    </nav>
  </header>

  <!-- ====== MAIN CONTENT & PAGES ====== -->
  <main>
    <div id="page-catcher" class="page">
      <div class="container" id="catcher-container">
        <div class="classified-stamp">CLASSIFIED</div>
        <div id="intro-content">
          <h1 data-text="Unmask Your Digital Ghost">Unmask Your Digital Ghost</h1>
          <p class="tagline">Is your browser hiding in the shadows? Let's find out.</p>
          <div class="run-btn-wrapper">
            <button id="run-btn" onclick="runDetection()">Run Detection</button>
          </div>
        </div>
        <div id="results-container"></div>
      </div>
    </div>
    
    <div id="page-faq" class="page">
        <div class="container static-page">
          <h2 data-text="Frequently Asked Questions">Frequently Asked Questions</h2>
          <h3>What is this tool?</h3><p>SpectraScan analyzes your browser's fingerprint for signs of manipulation. Websites use these fingerprints to track you. Our tool checks for common spoofing techniques and flags connections from known VPNs or proxies.</p>
          <h3>Why is a high risk score bad?</h3><p>A high score suggests your fingerprint is inconsistent, a common trait of antidetect browsers. While used for privacy, these browsers are often flagged as fraudulent by platforms like banks and e-commerce sites.</p>
          <h3>Is this 100% accurate?</h3><p>No tool is infallible in the cat-and-mouse game of browser security. This tool provides a strong, indicative analysis, not absolute proof.</p>
        </div>
    </div>
    
    <div id="page-privacy" class="page">
        <div class="container static-page">
            <h2 data-text="Privacy Policy">Privacy Policy</h2>
            <p>Your privacy is paramount. Our policy is simple: we don't store your data.</p>
            <h3>IP Address Handling</h3><p>Your IP address is used *only* to perform the check with third-party databases during your session. It is never logged or stored on our servers.</p>
            <h3>Browser Fingerprint</h3><p>All fingerprinting happens in your browser. Raw data (WebGL, Canvas, etc.) is never sent to us. Your device performs the analysis locally.</p>
            <h3>Cookies & Tracking</h3><p>This website does not use cookies for tracking. Period.</p>
        </div>
    </div>
  </main>
  
  <footer>
    CLASSIFIED // FOR ANALYTICAL PURPOSES ONLY
    <div class="footer-icons">
      <i class="fa-solid fa-fingerprint"></i>
      <i class="fa-solid fa-bug"></i>
      <i class="fa-solid fa-user-secret"></i>
    </div>
  </footer>
</div>

<script>
  /* --- NAVIGATION, THEME, ROUTER (NO CHANGES) --- */
  const hamburgerBtn = document.getElementById('hamburger-btn'); 
  const closeNavBtn = document.getElementById('close-nav-btn'); 
  const mainNav = document.getElementById('main-nav');
  hamburgerBtn.addEventListener('click', () => mainNav.classList.add('is-open'));
  closeNavBtn.addEventListener('click', () => mainNav.classList.remove('is-open'));
  
  const themeToggleBtn = document.getElementById('theme-toggle-btn'); 
  const body = document.body; 
  
  function applySavedTheme() { 
    const savedTheme = localStorage.getItem('theme'); 
    if (savedTheme === 'light') { 
      body.classList.add('light-mode'); 
      themeToggleBtn.innerHTML = '<i class="fa-solid fa-sun"></i>';
    } else { 
      body.classList.remove('light-mode'); 
      themeToggleBtn.innerHTML = '<i class="fa-solid fa-moon"></i>';
    } 
  }
  
  themeToggleBtn.addEventListener('click', () => { 
    body.classList.toggle('light-mode'); 
    const isLight = body.classList.contains('light-mode');
    localStorage.setItem('theme', isLight ? 'light' : 'dark');
    themeToggleBtn.innerHTML = isLight ? '<i class="fa-solid fa-sun"></i>' : '<i class="fa-solid fa-moon"></i>';
    setBackgroundState('default');
  });
  
  const pageContent = { '/': 'page-catcher', '/faq': 'page-faq', '/privacy': 'page-privacy' };
  
  function showPageContent(pageId) {
    document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
    const pageEl = document.getElementById(pageId);
    if(pageEl) pageEl.classList.add('active');
    document.querySelectorAll('.nav-link').forEach(link => {
      link.classList.remove('active');
      const linkPath = link.getAttribute('href');
      const currentPath = window.location.pathname;
      if (linkPath === currentPath || (currentPath === '/' && linkPath === '/')) {
        link.classList.add('active');
      }
    });
  }

  const router = () => { 
    const path = window.location.pathname; 
    const pageId = pageContent[path] || 'page-catcher'; 
    showPageContent(pageId); 
  };
  
  document.addEventListener('click', (e) => { 
    const a = e.target.closest('a'); 
    if (a && (a.matches('.nav-link') || a.matches('.logo-link'))) { 
      e.preventDefault(); 
      history.pushState(null, '', a.href); 
      mainNav.classList.remove('is-open'); 
      router(); 
    }
  });
  
  window.addEventListener('popstate', router);
  
  document.addEventListener('DOMContentLoaded', () => { 
    applySavedTheme(); 
    router(); 
  });

  /* --- CATCHER SCRIPT (REVISED) --- */
  function resetCatcher() { 
      const intro = document.getElementById('intro-content');
      if (intro) intro.style.display = 'block';
      document.getElementById('results-container').innerHTML = ''; 
      setBackgroundState('default');
      const stamp = document.querySelector('.classified-stamp');
      if(stamp) {
        stamp.classList.remove('safe', 'danger');
        stamp.textContent = "CLASSIFIED";
      }
  }

  window.runDetection = async function() {
    const intro = document.getElementById('intro-content');
    if (intro) intro.style.display = 'none';

    const resultsEl = document.getElementById('results-container');
    resultsEl.innerHTML = `<div class="loader-wrapper"><div class="scanner-circle"></div><p class="scanner-text">INTERROGATING BROWSER...</p></div>`;
    
    const minDelay = new Promise(resolve => setTimeout(resolve, 2000));
    
    const detectionPromise = (async () => {
        let riskScore = 0;
        const riskFactors = [];
        const TARGET_CHROME_VERSION = "138"; 

        // --- Server-Side IP Check ---
        try {
            const resp = await fetch('/api/ip-check', { cache: 'no-store' });
            const ipData = await resp.json();
            if (ipData.error) throw new Error("IP API Error");
            riskFactors.push({ label: 'IP Address', value: ipData.ip, isBad: false, alwaysShow: true });
            riskFactors.push({ label: 'VPN/Proxy', value: ipData.status, isBad: ipData.isProxy, alwaysShow: true });
            if (ipData.isProxy) riskScore += 3;
        } catch (e) {
            riskScore += 1;
            riskFactors.push({ label: 'IP/VPN Check', value: "Error during lookup", isBad: true, alwaysShow: true });
        }

        // --- Client-Side Checks ---
        const ua = navigator.userAgent;
        const majorChromeVersion = (ua.match(/Chrome\/(\d+)/) || [])[1];

        // 1. Strict Browser Version Check (Logic runs, but result is hidden)
        if (!ua.includes("Chrome") || majorChromeVersion !== TARGET_CHROME_VERSION) {
            riskScore += 4; // High penalty for wrong version
            riskFactors.push({ label: 'Version', value: `Mismatch`, isBad: true });
        }

        // 2. Automation flags (WebDriver)
        if (navigator.webdriver) {
            riskScore += 4;
            riskFactors.push({ label: 'Automation', value: 'WebDriver Active', isBad: true });
        }
        
        // 3. Plugin count heuristic (Logic runs, but result is hidden)
        if (navigator.plugins && navigator.plugins.length === 5) {
            riskScore += 1;
            riskFactors.push({ label: 'Plugins', value: 'Suspicious count', isBad: true });
        }
        
        // 4. Inconsistent Profile Check (New rule from user)
        const proResolutions = ['1920x1080', '2560x1440', '3840x2160'];
        const currentRes = `${window.screen.width}x${window.screen.height}`;
        if (majorChromeVersion === TARGET_CHROME_VERSION && !proResolutions.includes(currentRes)) {
            riskScore += 2; // Penalty for having the "right" UA with a "wrong" screen size
            riskFactors.push({ label: 'Profile Anomaly', value: 'Inconsistent fingerprint signature', isBad: true });
        }

        // 5. Canvas fingerprint randomization
        const canvasHash1 = getCanvasEntropy();
        await new Promise(resolve => setTimeout(resolve, 30));
        const canvasHash2 = getCanvasEntropy();
        if (canvasHash1 !== canvasHash2) {
            riskScore += 2;
            riskFactors.push({ label: 'Canvas', value: 'Randomized', isBad: true });
        }

        // 6. Generic WebGL renderer (bots/VMs)
        const renderer = getWebGLInfo().renderer.toLowerCase();
        if (renderer.includes("swiftshader") || renderer.includes("llvmpipe")) {
             riskScore += 3;
             riskFactors.push({ label: 'WebGL', value: "Software Emulated", isBad: true });
        }

        // Always add FP hash for reference
        let thumbmarkFingerprint = 'N/A';
        try { thumbmarkFingerprint = await ThumbmarkJS.getFingerprint(); } catch (err) {}
        riskFactors.push({ label: 'FP Hash', value: thumbmarkFingerprint, isBad: false, isHash: true, alwaysShow: true });

        // --- Build Results ---
        //  ******  THE FIX IS HERE ******
        const isBadBrowser = riskScore >= 3;
        setBackgroundState(isBadBrowser ? 'danger' : 'safe');
        
        let resultsHTML = `<div class="verdict-box ${isBadBrowser ? 'danger' : 'safe'}"><i class="fa-solid ${isBadBrowser ? 'fa-user-secret' : 'fa-user-check'} fa-lg"></i><span>${isBadBrowser ? "High Risk Profile Detected" : "Profile Appears Normal"}</span></div>`;
        resultsHTML += `<div class="risk-score">Threat Score: <strong>${riskScore}</strong></div>`;
        
        // Filter out the checks we want to hide (Version, Plugins)
        const displayableRiskFactors = riskFactors.filter(factor =>
             (factor.isBad || factor.alwaysShow) &&
             factor.label !== 'Version' &&
             factor.label !== 'Plugins'
        );

        let detailsGridHTML = displayableRiskFactors.map((factor, index) => {
            let valueClass = 'value';
            if (factor.isBad) valueClass += ' danger';
            else if (!factor.isHash) valueClass += ' safe';
            if (factor.isHash) valueClass += ' fingerprint-hash';
            
            let labelHTML = `<div class="label" style="animation-delay: ${index * 0.05}s">${factor.label}:</div>`;
            let valueHTML = `<div class="${valueClass}" style="animation-delay: ${index * 0.05}s">${factor.value}</div>`;
            return labelHTML + valueHTML;
        }).join('');
        
        resultsHTML += `<div class="details-grid">${displayableRiskFactors.length > 0 ? detailsGridHTML : '<div style="grid-column: 1 / -1; text-align: center; color: var(--accent-green);">All checks passed.</div>'}</div>`;
        resultsHTML += `<div class="results-footer"><div class="results-separator ${isBadBrowser ? 'danger' : ''}"></div><div class="run-btn-wrapper"><button id="reset-btn" onclick="resetCatcher()">Run Another Test</button></div></div>`;
        
        return {html: resultsHTML, bad: isBadBrowser};
    })();
    
    const [result] = await Promise.all([detectionPromise, minDelay]);
    
    resultsEl.innerHTML = result.html;
    
    const resetButton = document.getElementById('reset-btn');
    if (resetButton) {
        resetButton.classList.add(result.bad ? 'danger-button' : 'safe-button');
    }
  }
  
  function getCanvasEntropy() {try {const c=document.createElement('canvas');const ctx=c.getContext('2d');ctx.textBaseline="top";ctx.font="14px 'Arial'";ctx.fillText("BrowserFP",2,2);return hashString(c.toDataURL())}catch{return null}}
  function hashString(s){let h=0;for(let i=0;i<s.length;i++){h=((h<<5)-h)+s.charCodeAt(i);h|=0}return h}
  function getWebGLInfo(){try{const c=document.createElement('canvas');const gl=c.getContext('webgl')||c.getContext('experimental-webgl');if(!gl){return{vendor:"N/A",renderer:"N/A"}}const dbg=gl.getExtension('WEBGL_debug_renderer_info');return{vendor:gl.getParameter(dbg.UNMASKED_VENDOR_WEBGL),renderer:gl.getParameter(dbg.UNMASKED_RENDERER_WEBGL)}}catch{return{vendor:"N/A",renderer:"N/A"}}}

  /* --- DYNAMIC BACKGROUND SCRIPT (NO CHANGES) --- */
  const canvas = document.getElementById('matrix-bg');
  const ctx = canvas.getContext('2d');
  let backgroundInterval;

  const setupCanvas = () => {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    setBackgroundState('default');
  };

  const drawMatrix = (color, speed, charSet) => {
    const characters = charSet;
    const fontSize = 14;
    const columns = canvas.width / fontSize;
    const drops = Array(Math.floor(columns)).fill(1);
    const bg = body.classList.contains('light-mode') ? 'rgba(244, 244, 248, 0.05)' : 'rgba(13, 13, 18, 0.05)';
    return setInterval(() => {
        ctx.fillStyle = bg;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = color;
        ctx.font = fontSize + 'px Roboto Mono';
        for (let i = 0; i < drops.length; i++) {
            const text = characters[Math.floor(Math.random() * characters.length)];
            ctx.fillText(text, i * fontSize, drops[i] * fontSize);
            if (drops[i] * fontSize > canvas.height && Math.random() > 0.975) drops[i] = 0;
            drops[i]++;
        }
    }, speed);
  }
  
  let gridOffset = 0;
  const drawBlueGrid = () => {
    const gridColor = body.classList.contains('light-mode') ? 'rgba(0, 170, 255, 0.2)' : 'rgba(0, 170, 255, 0.15)';
    return setInterval(() => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.strokeStyle = gridColor;
        ctx.lineWidth = 1;
        gridOffset = (gridOffset + 0.3) % 40;
        for (let x = -gridOffset; x < canvas.width; x += 40) {
            ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, canvas.height); ctx.stroke();
        }
        for (let y = -gridOffset; y < canvas.height; y += 40) {
            ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(canvas.width, y); ctx.stroke();
        }
    }, 50);
  }

  function setBackgroundState(state) {
      const watermark = document.getElementById('background-watermark');
      const classifiedStamp = document.querySelector('.classified-stamp');
      body.classList.remove('safe-mode', 'danger-mode');
      clearInterval(backgroundInterval);
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      const isLight = body.classList.contains('light-mode');

      if (state === 'danger') {
          backgroundInterval = drawMatrix(isLight ? 'rgba(255, 71, 87, 0.4)' : 'rgba(255, 71, 87, 0.7)', 25, '01');
          watermark.setAttribute('data-text', 'COMPROMISED');
          body.classList.add('danger-mode');
          if (classifiedStamp) {
              classifiedStamp.textContent = "COMPROMISED";
              classifiedStamp.classList.add('danger');
              classifiedStamp.classList.remove('safe');
          }
      } else if (state === 'safe') {
          backgroundInterval = isLight ? drawMatrix('rgba(0, 0, 0, 0.1)', 50, '01') : drawBlueGrid();
          watermark.setAttribute('data-text', 'UNCLASSIFIED');
          body.classList.add('safe-mode');
          if (classifiedStamp) {
              classifiedStamp.textContent = "UNCLASSIFIED";
              classifiedStamp.classList.add('safe');
              classifiedStamp.classList.remove('danger');
          }
      } else { // default
          backgroundInterval = isLight ? drawMatrix('rgba(0, 0, 0, 0.1)', 50, '01') : drawMatrix('rgba(0, 255, 136, 0.7)', 40, 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789');
          watermark.setAttribute('data-text', '');
          if(classifiedStamp) {
              classifiedStamp.textContent = "CLASSIFIED";
              classifiedStamp.classList.remove('safe', 'danger');
          }
      }
  }

  window.addEventListener('resize', setupCanvas);
  document.addEventListener('DOMContentLoaded', setupCanvas);
</script>

</body>
</html>```